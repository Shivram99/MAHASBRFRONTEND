<div class="container">
  <h2>User Management</h2>

  <form #userForm="ngForm" (ngSubmit)="saveUser(userForm)" novalidate class="needs-validation">

    <!-- Username & Email -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
        <input type="text" id="username" name="username" class="form-control" [(ngModel)]="newUser.username" required
          #username="ngModel"
          [ngClass]="{'is-invalid': username.invalid && username.touched, 'is-valid': username.valid && username.touched}" />
        <div class="invalid-feedback">Username is required</div>
      </div>

      <div class="col-md-6">
        <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
        <input type="email" id="email" name="email" class="form-control" [(ngModel)]="newUser.email" required email
          #email="ngModel"
          [ngClass]="{'is-invalid': email.invalid && email.touched, 'is-valid': email.valid && email.touched}" />
        <div class="invalid-feedback">Valid email is required</div>
      </div>
    </div>

    <!-- Full Name & Office Name -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="fullName" class="form-label">Full Name</label>
        <input type="text" id="fullName" name="fullName" class="form-control"
          [(ngModel)]="newUser.userProfile!.fullName" #fullName="ngModel"
          [ngClass]="{'is-valid': fullName.valid && fullName.touched}" />
      </div>
      <div class="col-md-6">
        <label for="officeName" class="form-label">Office Name</label>
        <input type="text" id="officeName" name="officeName" class="form-control"
          [(ngModel)]="newUser.userProfile!.officeName" #officeName="ngModel"
          [ngClass]="{'is-valid': officeName.valid && officeName.touched}" />
      </div>
    </div>

    <!-- Office Address & Mobile Number -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="officeAddress" class="form-label">Office Address</label>
        <input type="text" id="officeAddress" name="officeAddress" class="form-control"
          [(ngModel)]="newUser.userProfile!.officeAddress" #officeAddress="ngModel"
          [ngClass]="{'is-valid': officeAddress.valid && officeAddress.touched}" />
      </div>
      <div class="col-md-6">
        <label for="mobileNumber" class="form-label">Mobile Number</label>
        <input type="text" id="mobileNumber" name="mobileNumber" class="form-control"
          [(ngModel)]="newUser.userProfile!.mobileNumber" pattern="^[0-9]{10}$" #mobileNumber="ngModel"
          [ngClass]="{'is-invalid': mobileNumber.invalid && mobileNumber.touched, 'is-valid': mobileNumber.valid && mobileNumber.touched}" />
        <div class="invalid-feedback">Mobile number must be 10 digits</div>
      </div>
    </div>

    <!-- Roles -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="roles" class="form-label">Role <span class="text-danger">*</span></label>
        <select id="roles" name="roles" class="form-select" [(ngModel)]="newUser.roles" required multiple
          #roles="ngModel"
          [ngClass]="{'is-invalid': roles.invalid && roles.touched, 'is-valid': roles.valid && roles.touched}">
          <option *ngFor="let role of rolesList" [value]="role.name">{{ role.name }}</option>
        </select>
        <div class="invalid-feedback">At least one role must be selected</div>
      </div>
      <!-- </div> -->

      <!-- Registry (conditional) -->
      <!-- <div class="row g-3 mb-3"> -->
      <div class="col-md-6">
        <label for="registryId" class="form-label">Registry</label>
        <select id="registryId" name="registryId" class="form-select" [(ngModel)]="newUser.registryId"
          [required]="canShowRegistry" [disabled]="!canShowRegistry" #registryId="ngModel"
          [ngClass]="{'is-invalid': registryId.invalid && registryId.touched && canShowRegistry, 'is-valid': registryId.valid && registryId.touched && canShowRegistry}">
          <option value="" *ngIf="canShowRegistry">-- Select Registry --</option>
          <ng-container *ngIf="canShowRegistry">
            <option *ngFor="let r of registries" [value]="r.id">{{ r.registryNameEn }}</option>
          </ng-container>
          <option *ngIf="!canShowRegistry" value="">Not Applicable</option>
        </select>
        <div class="invalid-feedback" *ngIf="canShowRegistry">Registry selection is required</div>
      </div>
    </div>
     <!-- Option shown when division is required -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="divisionCode" class="form-label">Division</label>
        <select id="divisionCode" name="divisionCode" class="form-select" [(ngModel)]="newUser.divisionCode"
          [required]="canShowDivision" [disabled]="!canShowDivision" #divisionCode="ngModel" [ngClass]="{
        'is-invalid': divisionCode.invalid && divisionCode.touched && canShowDivision,
        'is-valid': divisionCode.valid && divisionCode.touched && canShowDivision
      }">
          <!-- Option shown when division is required -->
          <option value="" *ngIf="canShowDivision">-- Select Division --</option>

          <!-- List divisions only if visible -->
          <ng-container *ngIf="canShowDivision">
            <option *ngFor="let d of division" [value]="d.divisionCode">
              {{ d.divisionName }} ({{ d.divisionCode }})
            </option>
          </ng-container>

          <!-- Fallback option -->
          <option *ngIf="!canShowDivision" value="">Not Applicable</option>
        </select>

        <!-- Error message only when touched and invalid -->
        <div class="invalid-feedback" *ngIf="divisionCode.invalid && divisionCode.touched && canShowDivision">
          Division selection is required
        </div>
      </div>
    </div>


    <!-- Submit Button -->
    <div class="d-flex justify-content-end">
      <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid">
        {{ newUser.id ? 'Update User' : 'Save User' }}
      </button>
    </div>


  </form>


  <!-- User List Table -->
  <div class=" mt-5">
    <h4>User List</h4>
    <table class="table-scroll table table-bordered table-striped mt-3 shadow-sm">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Email</th>
          <th>Roles</th>
          <th>Full Name</th>
          <th>Office</th>
          <th>Mobile</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users let i = index">
          <!-- <td>{{ user.id }}</td> -->
          <td>{{ i + 1 }}</td>
          <td>{{ user.username }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.roles?.join(', ') }}</td>
          <td>{{ user.userProfile?.fullName }}</td>
          <td>{{ user.userProfile?.officeName }}</td>
          <td>{{ user.userProfile?.mobileNumber }}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" (click)="editUser(user)">Edit</button>
            <button class="btn btn-sm btn-danger" (click)="deleteUser(user.id!)">Delete</button>

          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>