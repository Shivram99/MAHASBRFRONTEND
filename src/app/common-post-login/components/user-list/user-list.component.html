<div class="container">
  <h2>User Management</h2>

  <form
    #userForm="ngForm"
    (ngSubmit)="saveUser(userForm)"
    novalidate
    class="needs-validation p-4 border rounded shadow-sm bg-white"
    >

    <!-- Section: Basic Info -->
    <!-- <h5 class="mb-3 border-bottom pb-2 ">Basic Information</h5> -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
        <input
          type="text"
          id="username"
          name="username"
          class="form-control"
          [(ngModel)]="newUser.username"
          required
          #username="ngModel"
        [ngClass]="{
          'is-invalid': username.invalid && username.touched,
          'is-valid': username.valid && username.touched
        }"
          />
          <div class="invalid-feedback">Username is required</div>
        </div>

        <div class="col-md-6">
          <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
          <input
            type="email"
            id="email"
            name="email"
            class="form-control"
            [(ngModel)]="newUser.email"
            required
            email
            #email="ngModel"
        [ngClass]="{
          'is-invalid': email.invalid && email.touched,
          'is-valid': email.valid && email.touched
        }"
            />
            <div class="invalid-feedback">Valid email is required</div>
          </div>
        </div>

        <!-- Section: Profile Info -->
        <h5 class="mb-3 border-bottom pb-2 ">Profile Details</h5>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="fullName" class="form-label">Full Name</label>
            <input
              type="text"
              id="fullName"
              name="fullName"
              class="form-control"
              [(ngModel)]="newUser.userProfile!.fullName"
              #fullName="ngModel"
              [ngClass]="{ 'is-valid': fullName.valid && fullName.touched }"
              />
            </div>

            <div class="col-md-6">
              <label for="officeName" class="form-label">Office Name</label>
              <input
                type="text"
                id="officeName"
                name="officeName"
                class="form-control"
                [(ngModel)]="newUser.userProfile!.officeName"
                #officeName="ngModel"
                [ngClass]="{ 'is-valid': officeName.valid && officeName.touched }"
                />
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="officeAddress" class="form-label">Office Address</label>
                <input
                  type="text"
                  id="officeAddress"
                  name="officeAddress"
                  class="form-control"
                  [(ngModel)]="newUser.userProfile!.officeAddress"
                  #officeAddress="ngModel"
                  />
                </div>

                <div class="col-md-6">
                  <label for="mobileNumber" class="form-label">Mobile Number</label>
                  <input
                    type="text"
                    id="mobileNumber"
                    name="mobileNumber"
                    class="form-control"
                    [(ngModel)]="newUser.userProfile!.mobileNumber"
                    pattern="^[0-9]{10}$"
                    #mobileNumber="ngModel"
        [ngClass]="{
          'is-invalid': mobileNumber.invalid && mobileNumber.touched,
          'is-valid': mobileNumber.valid && mobileNumber.touched
        }"
                    />
                    <div class="invalid-feedback">Mobile number must be 10 digits</div>
                  </div>
                </div>

                <!-- Section: Role & Registry -->
                <!-- <h5 class="mb-3 border-bottom pb-2 text-primary">Role & Registry</h5> -->
                <div class="row g-3 mb-3">
                  <div class="col-md-6">
                    <label for="roles" class="form-label">Roles <span class="text-danger">*</span></label>
                    <select
                      id="roles"
                      name="roles"
                      class="form-select"
                      [(ngModel)]="newUser.roles"
                      required
                      multiple
                      #roles="ngModel"
        [ngClass]="{
          'is-invalid': roles.invalid && roles.touched,
          'is-valid': roles.valid && roles.touched
        }"
                      >
                      @for (role of rolesList; track role) {
                        <option [value]="role.name">{{ role.name }}</option>
                      }
                    </select>
                    <div class="invalid-feedback">At least one role must be selected</div>
                  </div>

                  <div class="col-md-6">
                    <label for="registryId" class="form-label">Registry</label>
                    <select
                      id="registryId"
                      name="registryId"
                      class="form-select"
                      [(ngModel)]="newUser.registryId"
                      [required]="canShowRegistry"
                      [disabled]="!canShowRegistry"
                      #registryId="ngModel"
        [ngClass]="{
          'is-invalid': registryId.invalid && registryId.touched && canShowRegistry,
          'is-valid': registryId.valid && registryId.touched && canShowRegistry
        }"
                      >
                      @if (canShowRegistry) {
                        <option value="">-- Select Registry --</option>
                      }
                      @if (canShowRegistry) {
                        @for (r of registries; track r) {
                          <option [value]="r.id">{{ r.registryNameEn }}</option>
                        }
                      }
                      @if (!canShowRegistry) {
                        <option value="">Not Applicable</option>
                      }
                    </select>
                    @if (canShowRegistry) {
                      <div class="invalid-feedback">
                        Registry selection is required
                      </div>
                    }
                  </div>
                </div>

                <!-- Section: Division & District -->
                <!-- <h5 class="mb-3 border-bottom pb-2 text-primary">Location Details</h5> -->
                <div class="row g-3 mb-3">
                  <div class="col-md-6">
                    <label for="divisionCode" class="form-label">Division</label>
                    <select
                      id="divisionCode"
                      name="divisionCode"
                      class="form-select"
                      [(ngModel)]="newUser.divisionCode"
                      [required]="canShowDivision"
                      [disabled]="!canShowDivision"
                      #divisionCode="ngModel"
        [ngClass]="{
          'is-invalid': divisionCode.invalid && divisionCode.touched && canShowDivision,
          'is-valid': divisionCode.valid && divisionCode.touched && canShowDivision
        }"
                      >
                      @if (canShowDivision) {
                        <option value="">-- Select Division --</option>
                      }
                      @if (canShowDivision) {
                        @for (d of division; track d) {
                          <option [value]="d.divisionCode">
                            {{ d.divisionName }} ({{ d.divisionCode }})
                          </option>
                        }
                      }
                      @if (!canShowDivision) {
                        <option value="">Not Applicable</option>
                      }
                    </select>
                    @if (divisionCode.invalid && divisionCode.touched && canShowDivision) {
                      <div class="invalid-feedback">
                        Division selection is required
                      </div>
                    }
                  </div>

                  <div class="col-md-6">
                    <label for="districtId" class="form-label">District</label>
                    <select
                      id="districtId"
                      name="districtId"
                      class="form-select"
                      [(ngModel)]="newUser.districtId"
                      [required]="canShowDistrict"
                      [disabled]="!canShowDistrict"
                      #districtId="ngModel"
        [ngClass]="{
          'is-invalid': districtId.invalid && districtId.touched && canShowDistrict,
          'is-valid': districtId.valid && districtId.touched && canShowDistrict
        }"
                      >
                      @if (canShowDistrict) {
                        <option value="">-- Select District --</option>
                      }
                      @if (canShowDistrict) {
                        @for (d of district; track d) {
                          <option [value]="d.districtId">{{ d.districtName }}</option>
                        }
                      }
                      @if (!canShowDistrict) {
                        <option value="">Not Applicable</option>
                      }
                    </select>
                    @if (districtId.invalid && districtId.touched && canShowDistrict) {
                      <div class="invalid-feedback">
                        District selection is required.
                      </div>
                    }
                  </div>
                </div>

                <!-- Buttons -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                  <button
                    type="submit"
                    class="btn btn-primary px-4"
                    [disabled]="userForm.invalid"
                    >
                    {{ newUser.id ? 'Update User' : 'Save User' }}
                  </button>

                  <!-- Cancel Button - only shows when updating -->
                  @if (newUser.id) {
                    <button
                      type="button"
                      class="btn btn-secondary px-4"
                      (click)="cancelEdit()"
                      >
                      Cancel
                    </button>
                  }
                </div>
              </form>



              <!-- User List Table -->
              <div class="mt-5">
                <h4>User List</h4>

                <!-- ðŸ” Search box -->
                <div class="row mb-3">
                  <div class="col-md-4">
                    <input
                      type="text"
                      class="form-control"
                      placeholder="Search by name, email, or office..."
                      [(ngModel)]="searchText"
                      />
                    </div>
                  </div>

                  <div class="table-scroll">
                    <table class="table table-bordered align-middle text-center">
                      <thead class="table-light">
                        <tr>
                          <th>ID</th>
                          <th>Username</th>
                          <th>Email</th>
                          <th>Roles</th>
                          <th>Full Name</th>
                          <th>Office</th>
                          <th>Mobile</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (user of users | filterUsers: searchText; track user; let i = $index) {
                          <tr
                            >
                            <td>{{ i + 1 }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.roles?.join(', ') }}</td>
                            <td>{{ user.userProfile?.fullName }}</td>
                            <td>{{ user.userProfile?.officeName }}</td>
                            <td>{{ user.userProfile?.mobileNumber }}</td>
                            <td>
                              <button class="btn btn-sm btn-warning me-1" (click)="editUser(user)">
                                Edit
                              </button>
                              <button
                                class="btn btn-sm btn-danger"
                                (click)="deleteUser(user.id!)"
                                >
                                Delete
                              </button>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>

              </div>