<!-- circular.component.html -->
<div class="container mt-4">
  <form [formGroup]="circularForm" (ngSubmit)="submit()" novalidate class="p-4 border rounded shadow-sm bg-white">

    <!-- Title -->
    <h5 class="mb-4">
      <i class="bi bi-file-earmark-text me-2"></i>
      {{ editMode ? 'Edit Circular' : 'Add New Circular' }}
    </h5>

    <!-- Subject -->
    <div class="mb-3">
      <label for="subject" class="form-label fw-semibold">
        Subject <span class="text-danger">*</span>
      </label>

      <input type="text" id="subject" formControlName="subject" class="form-control"
        placeholder="Enter circular subject" [ngClass]="{
        'is-invalid':
          circularForm.get('subject')?.invalid &&
          circularForm.get('subject')?.touched
      }" />
      <div class="invalid-feedback">Subject is required.</div>

    </div>

    <!-- Marathi Subject (With Suggestions) -->
    <!-- <div class="mb-3 ">
      <label for="marathiInput" class="form-label fw-semibold">
        Subject (Marathi Transliteration) <span class="text-danger">*</span>
      </label>

      <input type="text" id="marathiInput" formControlName="marathiInput" class="form-control"
        placeholder="Type in English to get Marathi suggestion..." (input)="onMarathiInputChange()"
        (keydown)="onMarathiKeyDown($event)" autocomplete="off" [ngClass]="{
        'is-invalid':
          circularForm.get('marathiInput')?.invalid &&
          circularForm.get('marathiInput')?.touched
      }" />
      <ul *ngIf="marathiSuggestions.length > 0" class="list-group position-absolute w-100 mt-1 shadow-sm"
        style="z-index: 1000; max-height: 200px; overflow-y: auto;">
        <li *ngFor="let word of marathiSuggestions; let i = index" class="list-group-item list-group-item-action"
          [class.active]="i === selectedIndex" (click)="selectMarathiSuggestion(word)">
          {{ word }}
        </li>
      </ul>

      <div class="invalid-feedback">Marathi subject is required.</div>
    </div> -->

    <!-- Date -->
    <div class="mb-3">
      <label for="date" class="form-label fw-semibold">
        Date <span class="text-danger">*</span>
      </label>
      <input type="date" id="date" formControlName="date" class="form-control" [ngClass]="{
        'is-invalid':
          circularForm.get('date')?.invalid &&
          circularForm.get('date')?.touched
      }" />
      <div class="invalid-feedback">Date is required.</div>

    </div>

    <!-- File -->
    <div class="mb-3">
      <label for="file" class="form-label fw-semibold">
        PDF File <span class="text-danger" *ngIf="!editMode">*</span>
      </label>

      <!-- Existing File Preview (Edit Mode Only) -->
      <div *ngIf="editMode && previousFileUrl" class="d-flex align-items-center gap-2 mb-2">
        <a [href]="previousFileUrl" target="_blank" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-file-earmark-pdf me-1"></i>
          View Current File
        </a>
        <small class="text-muted">(Uploading a new file will replace this one)</small>
      </div>

      <!-- File Input -->
      <input type="file" id="file" accept=".pdf" (change)="onFileSelected($event)" class="form-control" [ngClass]="{
        'is-invalid':
          (!selectedFile && circularForm.get('file')?.touched && !previousFileUrl)
      }" />
      <div class="invalid-feedback">PDF file is required.</div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-end mt-4">
      <!-- Cancel Button (only in edit mode) -->
      <button type="button" class="btn btn-secondary me-2" *ngIf="editMode" (click)="cancelEdit()">
        <i class="bi bi-x-circle me-1"></i> Cancel
      </button>

      <!-- Submit Button -->
      <button type="submit" class="btn btn-primary" [disabled]="
        circularForm.invalid ||
        (!selectedFile && !previousFileUrl)
      ">
        <i class="bi" [ngClass]="editMode ? 'bi-save' : 'bi-plus-circle'"></i>
        {{ editMode ? 'Update Circular' : 'Add Circular' }}
      </button>
    </div>

  </form>

  <!-- 
  <div class="container mt-3 position-relative" style="max-width: 400px;">
    <label for="marathiInput" class="form-label">Type in English (Marathi):</label>

    <input type="text" class="form-control" id="marathiInput" [(ngModel)]="inputText" (input)="onInputChange()"
      (keydown)="onKeyDown($event)" placeholder="Type here..." autocomplete="off" />

    <ul *ngIf="marathiSuggestions.length > 0" class="list-group position-absolute w-100 mt-1 shadow-sm"
      style="z-index: 1000; max-height: 200px; overflow-y: auto;">
      <li *ngFor="let word of marathiSuggestions; let i = index" class="list-group-item list-group-item-action"
        [class.active]="i === selectedIndex" (click)="selectSuggestion(word)">
        {{ word }}
      </li>
    </ul>
  </div> -->

  <hr />

  <div class="container mt-4">

    <!-- Header + Search -->
    <!-- Header + Search -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i> Circular List</h5>

      <div class="input-group w-50">
        <span class="input-group-text bg-primary text-white">
          <i class="bi bi-search"></i>
        </span>
        <input type="text" class="form-control" placeholder="Search by subject or date..." [(ngModel)]="searchText"
          (input)="filterCirculars()" />
      </div>
    </div>
    <!-- Pagination + Rows per page -->
    <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap">

      <!-- Rows per page -->
      <div class="d-flex align-items-center mb-2 mb-md-0">
        <label class="me-2 mb-0 fw-semibold text-secondary">Rows per page:</label>
        <select class="form-select form-select-sm w-auto" [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
          <option *ngFor="let option of pageSizeOptions" [value]="option">
            {{ option }}
          </option>
        </select>
      </div>

      <!-- Pagination -->
      <nav *ngIf="totalPages > 1">
        <ul class="pagination pagination-sm justify-content-center mb-0">
          <!-- Previous -->
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link" (click)="changePage(currentPage - 1)">
              Previous
            </button>
          </li>

          <!-- First page -->
          <li class="page-item" *ngIf="currentPage > 3">
            <button class="page-link" (click)="changePage(1)">1</button>
          </li>

          <!-- Dots before -->
          <li class="page-item disabled" *ngIf="currentPage > 4">
            <span class="page-link">...</span>
          </li>

          <!-- Visible pages -->
          <li class="page-item" *ngFor="let page of visiblePages" [class.active]="page === currentPage">
            <button class="page-link" (click)="changePage(page)">
              {{ page }}
            </button>
          </li>

          <!-- Dots after -->
          <li class="page-item disabled" *ngIf="currentPage < totalPages - 3">
            <span class="page-link">...</span>
          </li>

          <!-- Last page -->
          <li class="page-item" *ngIf="currentPage < totalPages - 2">
            <button class="page-link" (click)="changePage(totalPages)">
              {{ totalPages }}
            </button>
          </li>

          <!-- Next -->
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <button class="page-link" (click)="changePage(currentPage + 1)">
              Next
            </button>
          </li>
        </ul>
      </nav>
    </div>
    <!-- Table -->
    <table class="table table-bordered align-middle text-center">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Subject</th>
          <th>Date</th>
          <th>File</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of paginatedCirculars; let i = index">
          <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
          <td>{{ c.subject }}</td>
          <td>{{ c.date | date: 'dd-MM-yyyy' }}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" (click)="openPdfModal(c.fileUrl, c.subject)">
              <i class="bi bi-eye-fill"></i> View
            </button>
          </td>
          <td>
            <button class="btn btn-sm btn-warning me-2" (click)="editCircular(c)">
              <i class="bi bi-pencil-square"></i> Edit
            </button>
            <button class="btn btn-sm btn-danger" (click)="deleteCircular(c.id!)">
              <i class="bi bi-trash"></i> Delete
            </button>
          </td>
        </tr>

        <tr *ngIf="paginatedCirculars.length === 0">
          <td colspan="5" class="text-muted">No circulars found.</td>
        </tr>
      </tbody>
    </table>
  </div>



  <!-- PDF Modal -->
  <div class="modal fade show d-block" *ngIf="isPdfModalOpen">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ pdfTitle }}</h5>
          <button type="button" class="btn-close" (click)="closePdfModal()"></button>
        </div>

        <div class="modal-body" style="height:80vh; overflow:auto;">
          <!-- PDF Viewer -->
          <iframe *ngIf="pdfUrl" [src]="pdfUrl" width="100%" height="100%"></iframe>
        </div>

        <div class="modal-footer">
          <a [href]="pdfUrl" [attr.download]="pdfTitle + '.pdf'" class="btn btn-success">
            <i class="bi bi-download"></i> Download
          </a>
          <button class="btn btn-secondary" (click)="closePdfModal()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop -->
  <div class="modal-backdrop fade show" *ngIf="isPdfModalOpen"></div>